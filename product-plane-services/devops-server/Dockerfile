FROM amazoncorretto:17-alpine-jdk

VOLUME /tmp

ADD ./product-plane-services/registry-api/target/odm-platform-pp-registry-api-*.jar ./
ADD ./product-plane-services/devops-api/target/odm-platform-pp-devops-api-*.jar ./
ADD ./utility-plane-services/observer-api/target/odm-platform-up-observer-api-*.jar ./
ADD ./utility-plane-services/executor-api/target/odm-platform-up-executor-api-*.jar ./
COPY ./product-plane-services/devops-server/target/odm-platform-pp-devops-server-*.jar ./application.jar

ARG SPRING_PROFILES_ACTIVE=docker
ARG SPRING_HOSTNAME=localhost
ARG SPRING_PORT=8002
ARG SPRING_PROPS
ARG JAVA_OPTS
ARG DATABASE_URL=jdbc:postgresql://localhost:5432/odmpdb
ARG DATABASE_USERNAME=usr
ARG DATABASE_PASSWORD=pwd
ARG FLYWAY_SCHEMA=ODMDEVOPS
ARG FLYWAY_SCRIPTS_DIR=postgresql
ARG H2_CONSOLE_ENABLED=false
ARG H2_CONSOLE_PATH=h2-console
ARG REGISTRY_HOSTNAME=localhost
ARG REGISTRY_PORT=8001
ARG AZUREDEVOPS_HOSTNAME=localhost
ARG AZUREDEVOPS_PORT=9003
ARG AZUREDEVOPS_CHECK_AFTER_CALLBACK=true
ARG POLICYSERVICE_ACTIVE=false
ARG POLICYSERVICE_HOSTNAME=localhost
ARG POLICYSERVICE_PORT=8005
ARG NOTIFICATIONSERVICE_ACTIVE=false
ARG NOTIFICATIONSERVICE_HOSTNAME=localhost
ARG NOTIFICATIONSERVICE_PORT=8006

ENV SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
ENV SPRING_HOSTNAME=${SPRING_HOSTNAME}
ENV SPRING_PORT=${SPRING_PORT}
ENV SPRING_PROPS=${SPRING_PROPS}
ENV JAVA_OPTS=${JAVA_OPTS}
ENV DATABASE_URL=${DATABASE_URL}
ENV DATABASE_USERNAME=${DATABASE_USERNAME}
ENV DATABASE_PASSWORD=${DATABASE_PASSWORD}
ENV FLYWAY_SCHEMA=${FLYWAY_SCHEMA}
ENV FLYWAY_SCRIPTS_DIR=${FLYWAY_SCRIPTS_DIR}
ENV H2_CONSOLE_ENABLED=${H2_CONSOLE_ENABLED}
ENV H2_CONSOLE_PATH=${H2_CONSOLE_PATH}
ENV REGISTRY_HOSTNAME=${REGISTRY_HOSTNAME}
ENV REGISTRY_PORT=${REGISTRY_PORT}
ENV AZUREDEVOPS_HOSTNAME=${AZUREDEVOPS_HOSTNAME}
ENV AZUREDEVOPS_PORT=${AZUREDEVOPS_PORT}
ENV AZUREDEVOPS_CHECK_AFTER_CALLBACK=${AZUREDEVOPS_CHECK_AFTER_CALLBACK}
ENV POLICYSERVICE_ACTIVE=${POLICYSERVICE_ACTIVE}
ENV POLICYSERVICE_HOSTNAME=${POLICYSERVICE_HOSTNAME}
ENV POLICYSERVICE_PORT=${POLICYSERVICE_PORT}
ENV NOTIFICATIONSERVICE_ACTIVE=${NOTIFICATIONSERVICE_ACTIVE}
ENV NOTIFICATIONSERVICE_HOSTNAME=${NOTIFICATIONSERVICE_HOSTNAME}
ENV NOTIFICATIONSERVICE_PORT=${NOTIFICATIONSERVICE_PORT}

EXPOSE $SPRING_PORT

ENTRYPOINT [ "sh", "-c", "java $JAVA_OPTS  -Dspring.profiles.active=$SPRING_PROFILES_ACTIVE $SPRING_PROPS -jar ./application.jar" ]